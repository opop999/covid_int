---
title: "Predictors of Depression During the Covid-19 Pandemic" 
subtitle: "Multiple Regression"
author: "Sarka Tesarova, Ondrej Pekacek, Alessandro Porrovecchio"
date: "Last edited `r format (Sys.time(),'%d. %m. %Y')`"
output:
  html_document: 
    toc: yes
    toc_depth: 2
    toc_float: true
    number_sections: true
    theme: readable
    code_folding: hide
    code_download: true
    includes:
      in_header: header.html
---


```{r loading packages and dataset, message=FALSE, warning=FALSE}
# The following packages might need to be installed onto your version 
# of R prior to the running of the code below.

# Package names
packages <- c("corrplot", "dplyr", "mice", "car", "miceadds", "fastDummies")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

imputed_df <- readRDS("data/imputed_dataset.rds")

# We also try to limit the decimals to three significant figures
options(digits = 3, scipen = 999)

```

## Correlation plot

```{r}
mi_cor_df <- complete(imputed_df, action = "long", include = TRUE) %>% 
   dummy_cols(select_columns = c("q03_relationship_type", "q01_gender"), remove_selected_columns = TRUE) %>% 
   mutate(across(everything(), ~ as.numeric(.))) %>% 
   select(-c("q03_relationship_type_NA", "q01_gender_NA")) %>% 
   as.mids()

mi_cor <- micombine.cor(mi_cor_df, 
              method = "spearman", 
              conf.level = 0.95)

# Add significance matrix
corrplot(attr(mi_cor,"r_matrix"), 
         method = "circle", 
             title = "Correlation Matrix - Spearman Coefficient", 
             type = "lower", 
             # p.mat = res1$p, 
             # sig.level = .05, 
             mar = c(0,0,1,0))


```


# Stepwise regression model on multiply imputed dataset

```{r} 
# outcome <- "PHQ8"
# predictors <- c("q01_gender", "q02_age", "q04_children", "q36_econ_worry", "q18_02_soc_media", "q47_self_reporting_health", "q49_health_limitations")
# 
# formula_bic <- as.formula(
#   paste(outcome,
#     paste(predictors, collapse = " + "),
#     sep = " ~ "
#   )
# )

# test_lm <- lm(formula_bic, mice::complete(imputed_df))
# test <- imputed_df %>% 
#    mice::complete("all") %>%
#   lapply(lm, formula = PHQ8 ~ q01_gender + q02_age + q04_children + q36_econ_worry + 
#     q18_02_soc_media + q47_self_reporting_health + q49_health_limitations) %>%
#   lapply(Anova) 
# car::durbinWatsonTest(stepwise_BIC_fit)
# car::vif(test_lm)
# car::Anova(test_lm, p.adjust.method = TRUE)
# 

# test_jmv <- jmv::linReg(
#     data = data_subset,
#     dep = "PHQ8",
#     covs = "q02_age",
#     factors = vars("q01_gender"),
#      blocks = list(
#         list(
#             "q01_gender",
#             "q02_age")),
#     refLevels = list(
#         list(
#             var = "q01_gender",
#             ref = "female")),
#     r2Adj = TRUE,
#     aic = TRUE,
#     bic = TRUE,
#     rmse = TRUE,
#     modelTest = TRUE,
#     anova = TRUE,
#     ci = TRUE,
#     stdEst = TRUE,
#     ciStdEst = TRUE,
#     durbin = TRUE,
#     collin = TRUE)

# Remove factor ordering for better interpretation within regression coefficients
imputed_df <- complete(imputed_df, action = "long", include = TRUE) %>% 
   mutate(across(where(is.ordered), ~ factor(., ordered = FALSE))) %>% 
   as.mids()
```


```{r} 
# Testing model chosen based by stepwise algoritm on its BIC score
stepwise_BIC_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q04_children +
  q36_econ_worry +
  q18_02_soc_media +
  q47_self_reporting_health +
  q49_health_limitations + 0)) %>%
  pool()

summary(stepwise_BIC_fit) %>% arrange(p.value)

stepwise_BIC_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q04_children +
  q36_econ_worry +
  q18_02_soc_media +
  q47_self_reporting_health +
  q49_health_limitations")

stepwise_BIC_anova$r.squared

stepwise_BIC_anova$anova.table %>% arrange(desc(`F value`))


# Testing model chosen based by stepwise algoritm on its AIC score
stepwise_AIC_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q04_children +
  q36_econ_worry +
  q18_02_soc_media +
  q47_self_reporting_health +
  q49_health_limitations +
  q03_relationship_type +
  q20_public_info +
  q34_02_face_mask +
  q38_alcohol +
  q40_smoking +
  q48_chronic_illness + 0)) %>%
  pool()

summary(stepwise_AIC_fit) %>% arrange(p.value)

stepwise_AIC_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q04_children +
  q36_econ_worry +
  q18_02_soc_media +
  q47_self_reporting_health +
  q49_health_limitations +
  q03_relationship_type +
  q20_public_info +
  q34_02_face_mask +
  q38_alcohol +
  q40_smoking +
  q48_chronic_illness")

stepwise_AIC_anova$r.squared

stepwise_AIC_anova$anova.table %>% arrange(desc(`F value`))

```

# Theoretically-devised regression model on multiply imputed dataset

```{r}
th_1_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education + 0)) %>%
  pool()

th_2_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry + 0)) %>%
  pool()

th_3_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry +
  q40_smoking +
  q42_sport +
  q38_alcohol +
  q35_01_contact_close_family +
  q35_03_contact_friends + 0)) %>%
  pool()


th_4_fit <- with(imputed_df, lm(PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry +
  q40_smoking +
  q42_sport +
  q38_alcohol +
  q35_01_contact_close_family +
  q35_03_contact_friends + 
  q47_self_reporting_health +
  q48_chronic_illness +
  q49_health_limitations + 0)) %>%
  pool()

th_1_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education")

th_2_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry")

th_3_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry +
  q40_smoking +
  q42_sport +
  q38_alcohol +
  q35_01_contact_close_family +
  q35_03_contact_friends")

th_4_anova <- mi.anova(imputed_df, "PHQ8 ~ q01_gender +
  q02_age +
  q03_relationship_type +  
  q04_children +
  q11_education +
  q18_02_soc_media +
  q20_public_info +
  q34_02_face_mask +
  q34_07_hand_washing +
  q36_econ_worry +
  q40_smoking +
  q42_sport +
  q38_alcohol +
  q35_01_contact_close_family +
  q35_03_contact_friends + 
  q47_self_reporting_health +
  q48_chronic_illness +
  q49_health_limitations")

summary(th_1_fit) %>% arrange(p.value)
summary(th_2_fit) %>% arrange(p.value)
summary(th_3_fit) %>% arrange(p.value)
summary(th_4_fit) %>% arrange(p.value)


th_1_anova$r.squared
th_2_anova$r.squared
th_3_anova$r.squared
th_4_anova$r.squared

th_1_anova$anova.table %>% arrange(desc(`F value`))
th_2_anova$anova.table %>% arrange(desc(`F value`))
th_3_anova$anova.table %>% arrange(desc(`F value`))
th_4_anova$anova.table %>% arrange(desc(`F value`))

```

```{r}
ggplot(complete(imputed_df), aes(q02_age, PHQ8, color = q11_education)) + geom_point(position = "jitter", alpha = 0.2) + geom_smooth()

# + geom_parallel_slopes(se = TRUE)
```

