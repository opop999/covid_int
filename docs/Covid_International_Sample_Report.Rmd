---
title: "Predictors of Depression During the Covid-19 Pandemic" 
subtitle: "International sample report v0.1"
author: "Sarka Tesarova, Ondrej Pekacek, Alessandro Porrovecchio"
date: "Last edited `r format (Sys.time(),'%d. %m. %Y')`"
output:
  html_document: 
    toc: yes
    toc_depth: 2
    toc_float: true
    number_sections: true
    theme: readable
    code_folding: hide
    code_download: true
    includes:
      in_header: header.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(out.width = "90%", echo = TRUE)
```

```{css, echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
  max-height: 600px;
  overflow-y: auto;
}
#TOC {
  font-size: 12px;
}
h1.title {
  font-size: 28px;
}
h1 {
  font-size: 23px;
}
h2 {
  font-size: 18px;
}
h3 {
  font-size: 16px;
}
h4 {
  font-size: 12px;
}
h4.author {
  font-style: italic;
  font-size: 16px;
}
h4.date {
  font-size: 16px;
}
```

# Analysis of the international sample

## Loading the dataset, required R packages and data wrangling

```{r loading packages and dataset, message=FALSE, warning=FALSE}
# The following packages might need to be installed onto your version 
# of R prior to the running of the code below.

# Package names
packages <- c("MASS", "lavaan", "processR", "corrplot", "tidytext", "tidyverse", "haven", "jmv", "Hmisc", "cluster", "kableExtra", "factoextra")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

# We load the original Czech dataset (in SPSS format) from a local directory.
data <- zap_labels(haven::read_sav(file = "INTERNATIONAL DATASET_12 Oct_final.sav"))

# For use in correlation analysis, we duplicate the dataset under name data_corr
data_corr <- data

# We also try to limit the decimals to three significant figures
options(digits = 3, scipen = 999)

```

```{r}
# Calculating PH8

data <- data %>%
  mutate(Q49_1_rec = recode(Q49_1,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_2_rec = recode(Q49_2,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_3_rec = recode(Q49_3,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_4_rec = recode(Q49_4,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_5_rec = recode(Q49_5,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_6_rec = recode(Q49_6,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_7_rec = recode(Q49_7,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         Q49_8_rec = recode(Q49_8,
            `1` = 0,
            `2` = 1,
            `3` = 2,
            `4` = 3),
         PHQ8 = Q49_1_rec + Q49_2_rec + Q49_3_rec + Q49_4_rec + Q49_5_rec + Q49_6_rec + Q49_7_rec + Q49_8_rec)
```


```{r}
# Renaming variables to identical ones as before
data_subset <- data %>% 
  transmute(country = recode_factor(as_factor(Country),
            `1` = "IT",
            `2` = "FR",
            `3` = "PL",
            `4` = "UK",
            `5` = "CZ",
            `6` = "SW"),
            q01_gender = recode_factor(as_factor(Q3),
            `1` = "male",
            `2` = "female",
            `3` = "other"),
            q02_age = Q4,
            q02_age_group = recode_factor(as_factor(Q4_AGE_r),
            `1` = "16-29 years",
            `2` = "30-49 years",
            `3` = "50-64 years",
            `4` = "65+"),
            q03_relationship_type = recode_factor(as_factor(Q5),
            `1` = "single",
            `2` = "relationship",
            `3` = "married",
            `4` = "divorced",
            `5` = "widowed"),
            q04_children = recode_factor(as_factor(Q6),
            `1` = "yes",
            `2` = "no"),
            q11_education = recode_factor(as_factor(Q13R),
            `1` = "low",
            `2` = "medium",
            `3` = "high"),
            q18_02_soc_media = recode_factor(as_factor(replace_na(Q21_2, 0)),
            `0` = "no",
            `1` = "yes"),
            q20_public_info = recode_factor(as_factor(Q23),
            `1` = "yes",
            `2` = "no",
            `99` = "do_not_know"),
            q34_02_face_mask = recode_factor(as_factor(Q37_2),
            `1` = "yes",
            `2` = "no"),
            q34_07_hand_washing = recode_factor(as_factor(Q37_7),
            `1` = "yes",
            `2` = "no"),
            q35_01_contact_close_family = recode_factor(as_factor(Q38_1),
            `1` = "less_often",
            `2` = "as_before",
            `3` = "more_often"),
            q35_03_contact_friends = recode_factor(as_factor(Q38_3),
            `1` = "less_often",
            `2` = "as_before",
            `3` = "more_often"),
            q36_econ_worry = recode_factor(as_factor(Q39),
            `1` = "very_serious",
            `2` = "serious",
            `3` = "limited"),
            q38_alcohol = recode_factor(as_factor(Q42),
            `1` = "yes",
            `2` = "no"),
            q40_smoking = recode_factor(as_factor(Q44),
            `1` = "yes",
            `2` = "no"),
            q42_sport = recode_factor(as_factor(Q46),
            `1` = "yes",
            `2` = "no"),
            q47_self_reporting_health = recode_factor(as_factor(Q50),
            `1` = "excellent",
            `2` = "good",
            `3` = "neutral",
            `4` = "bad",
            `5` = "very_bad"),
            q48_chronic_illness = recode_factor(as_factor(Q51),
            `1` = "yes",
            `2` = "no"),
            q49_health_limitations = recode_factor(as_factor(Q52),
            `1` = "limits",
            `2` = "partially_limits",
            `3` = "no_limits"),
            q30_concern_infection_covid = Q33,
            q31_concern_infection_friends = Q34,
            q33_01_concern_situation = Q36_1,
            q33_02_concern_low_control = Q36_2,
            q33_03_concern_survival_covid = Q36_3,
            q33_04_concern_change_employment = Q36_4,
            q33_05_concern_infecting_others = Q36_5,
            PHQ8 = PHQ8)
```


```{r}
# Filtering out Czech sample for analyses
data <- data_full %>%
        filter(country != "CZ")

```

```{r}
data["info_missing"] <- if_else(data$q20_public_info %in% c(NA, "yes", "no"), 0, 1)


# Is q20_public_info MAR or MNAR?
mcar_test(data[,c("q01_gender", "q02_age", "q03_relationship_type", "q04_children", "q18_02_soc_media")])

summary(data)

```






## Descriptive statistics

### Sample descriptive statistics {.tabset .tabset-pills}

#### Population pyramid of the full sample

```{r}
data_full[data_full$country %in% c("IT", "FR", "PL") & !is.na(data_full$q02_age),] %>%
  ggplot(aes(x = q02_age, 
             fill = q01_gender)) + 
  geom_bar(data = data_full[data_full$country %in% c("IT", "FR", "PL") & data_full$q01_gender == "female" & !is.na(data_full$q02_age),]) + 
  geom_bar(data = data_full[data_full$country %in% c("IT", "FR", "PL") & data_full$q01_gender == "male" & !is.na(data_full$q02_age),], 
           aes(y = ..count..*(-1))) + 
  scale_y_continuous(breaks = seq(-250, 250, 50), 
                     labels = abs(seq(-250, 250, 50)), 
                     limits = c(-100, 100)) + 
  scale_x_continuous(breaks = seq(15, 100, 5), 
                     labels = seq(15, 100, 5), 
                     limits = c(15, 100)) +
  coord_flip() +
  theme_bw() +
  theme(legend.title = element_blank()) +
  facet_grid(cols = vars(country)) + 
  scale_fill_manual(values = c("#E64B35CC", "#00A087CC")) +
  xlab("Age") +
  ylab("Count")

data_full[data_full$country %in% c("UK", "CZ", "SW") & !is.na(data_full$q02_age),]  %>%
  ggplot(aes(x = q02_age, 
             fill = q01_gender)) + 
  geom_bar(data = data_full[data_full$country %in% c("UK", "CZ", "SW") & data_full$q01_gender == "female" & !is.na(data_full$q02_age),]) + 
  geom_bar(data = data_full[data_full$country %in% c("UK", "CZ", "SW") & data_full$q01_gender == "male" & !is.na(data_full$q02_age),], 
           aes(y = ..count..*(-1))) + 
  scale_y_continuous(breaks = seq(-250, 250, 50), 
                     labels = abs(seq(-250, 250, 50)), 
                     limits = c(-100, 100)) + 
  scale_x_continuous(breaks = seq(15, 100, 5), 
                     labels = seq(15, 100, 5), 
                     limits = c(15, 100)) +
  coord_flip() +
  theme_bw() +
  theme(legend.title = element_blank()) +
  facet_grid(cols = vars(country)) + 
  scale_fill_manual(values = c("#E64B35CC", "#00A087CC")) +
  xlab("Age") +
  ylab("Count")

```

#### Descriptives of Depression index (PHQ8)

```{r, comment = ""}
# To summarize the dependent continuous variable, we use the descriptives() 
# function from the jmv package.

descriptives <- jmv::descriptives(
    data = data,
    vars = "PHQ8",
    freq = TRUE,
    box = TRUE,
    median = FALSE,
    range = TRUE,
    sd = TRUE,
    pc = TRUE)

descriptives$descriptives
```

#### Plots of Depression index (PHQ8)

```{r, comment = ""}
data %>%
  filter(PHQ8 != "NA") %>% 
  ggplot(aes(y = PHQ8)) +
         geom_boxplot(fill = "#4DBBD5CC") +
         theme_bw() +
         scale_y_continuous(breaks = seq(0, 24, 1), 
                            labels = seq(0, 24, 1), 
                            limits = c(0, 24)) +
         theme(legend.position = "none", 
               axis.title.x = element_blank(),
               axis.text.x = element_blank(), 
               axis.ticks.x = element_blank(), 
               axis.line.x = element_blank(), 
               panel.grid.major.x = element_blank(), 
               panel.grid.minor = element_blank())

data %>% 
  filter(PHQ8 != "NA") %>% 
  ggplot(aes(x = as_factor(PHQ8))) +
         geom_bar(fill = "#4DBBD5CC") +
         scale_y_continuous(breaks = seq(0, 700, 50), 
                            labels = seq(0, 700, 50), 
                            limits = c(0, 700)) +
         theme_bw() +
         theme(legend.position = "none") +
         xlab("PHQ8")

```

#### Descriptives of demographic variables

```{r sample demography descriptives}
# To summarize the key demographic variables, we use the descriptives() 
# function from the jmv package.

demo_descriptives <- jmv::descriptives(
    data = data,
    vars = vars("q01_gender",
                "q02_age_group",
                "q03_relationship_type",
                "q04_children",
                "q11_education"),
    bar = TRUE,
    freq = TRUE,
    missing = FALSE,
    mean = FALSE,
    median = FALSE,
    sd = FALSE,
    min = FALSE,
    max = FALSE)

demo_descriptives$frequencies	

```

#### Plots of demographic variables

```{r, comment = ""}
data %>% 
  filter(q01_gender %in% c("male", "female"), 
         q02_age_group != "NA") %>% 
  ggplot(aes(x = q01_gender)) +
         geom_bar(aes(fill = q01_gender)) +
         scale_y_continuous(breaks = seq(0, 3500, 500), 
                            labels = seq(0, 3500, 500), 
                            limits = c(0, 3500)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q02_age_group)) +
         scale_fill_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC"))

data %>% 
  filter(q01_gender %in% c("male", "female"), 
         q03_relationship_type != "NA") %>% 
  ggplot(aes(x = q01_gender)) +
         geom_bar(aes(fill = q01_gender)) +
         scale_y_continuous(breaks = seq(0, 2500, 250), 
                            labels = seq(0, 2500, 250), 
                            limits = c(0, 2500)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q03_relationship_type), 
                    rows = vars(q04_children)) +
         scale_fill_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC"))

data %>% 
  filter(q01_gender %in% c("male", "female"), 
         q11_education != "NA", 
         q02_age_group != "NA") %>% 
  ggplot(aes(x = q01_gender)) +
         geom_bar(aes(fill = q01_gender)) +
         scale_y_continuous(breaks = seq(0, 1600, 250), 
                            labels = seq(0, 1600, 250), 
                            limits = c(0, 1600)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q11_education), 
                    rows = vars(q02_age_group)) +
         scale_fill_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC"))

```


### Descriptives of PHQ8 and distinct groups {.tabset .tabset-pills}

#### Depression by gender age and other demographics
```{r}
data_full %>%
  filter(q01_gender != "other", 
         PHQ8 != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(country)) +
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Countries") 

data %>% 
  filter(q01_gender != "other", 
         q02_age_group != "NA",
         PHQ8 != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Age groups")

# For reproducibility of results
set.seed(2021)

data %>% 
  filter(q01_gender != "other",
         q02_age_group != "NA",
         PHQ8 != "NA") %>% 
  ggplot(aes(x = q02_age, 
             y = PHQ8)) +
         geom_jitter(na.rm	= TRUE, 
                     size = 1, 
                     alpha = 0.1) +
         stat_smooth(method = "gam", 
                     formula = y ~ x, 
                     na.rm	= TRUE, 
                     aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.title = element_blank()) +
         scale_x_continuous(limits = c(16, 92), 
         breaks = seq(from = 16, 
                      to = 92, 
                      by = 8)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         xlab("Age") + 
         ggtitle("Age groups")

data %>% 
  filter(q01_gender != "other", 
         q03_relationship_type != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q03_relationship_type)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Relationship type")

data %>%
  filter(q01_gender != "other", 
         q11_education != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q11_education)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Educational attainment")

data %>%
  filter(q01_gender != "other") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.x = element_blank()) +
         facet_grid(cols = vars(q04_children)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Children")
```

#### Depression and Covid-related circumstances
```{r}
data %>%
  filter(q01_gender != "other", 
         q18_02_soc_media != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q18_02_soc_media), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Social media") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q20_public_info != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q20_public_info), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Enough information") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q34_02_face_mask != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q34_02_face_mask), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Face mask wearing") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q34_07_hand_washing != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q34_07_hand_washing), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Increased hand washing") + 
         coord_flip()
data %>%
  filter(q01_gender != "other", 
         q36_econ_worry != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q36_econ_worry), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Perceived economic impact of Covid") + 
         coord_flip()

```

#### Depression and lifestyle factors
```{r}
data %>%
  filter(q01_gender != "other", 
         q35_01_contact_close_family != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q35_01_contact_close_family), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Frequency of physical contact - close family") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q35_03_contact_friends != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q35_03_contact_friends), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Frequency of physical contact - friends") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q38_alcohol != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q38_alcohol), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Alcohol") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q40_smoking != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q40_smoking), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Smoking") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q42_sport != "NA",
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q42_sport ), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Sport") + 
         coord_flip()
```

#### Depression and health
```{r}
data %>%
  filter(q01_gender != "other", 
         q47_self_reporting_health != "NA", 
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q47_self_reporting_health), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Self-reported Health") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q48_chronic_illness != "NA", 
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q48_chronic_illness), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) +
         ggtitle("Chronic illness") + 
         coord_flip()

data %>%
  filter(q01_gender != "other", 
         q49_health_limitations != "NA", 
         q02_age_group != "NA") %>% 
  ggplot(aes(y = PHQ8, 
             x = q01_gender)) +
         geom_boxplot(na.rm = TRUE, 
                      aes(color = q01_gender)) +
         theme_bw() +
         theme(legend.position = "none", axis.title.y = element_blank()) +
         facet_grid(cols = vars(q49_health_limitations ), rows = vars(q02_age_group)) + 
         scale_color_manual(values = c("female" = "#E64B35CC", "male" = "#00A087CC")) + 
         ggtitle("Health limitations") + 
         coord_flip()

```

```{r PHQ8 transformation, include=FALSE}
# Normality transformation: finding lambda for entire model that 
# includes PHQ8 as a dependent variable
YJ <- car::powerTransform(lm(PHQ8 ~ q01_gender
                             + q02_age
                             + q03_relationship_type
                             + q04_children 
                             # + q11_education
                             + q18_02_soc_media
                             # + q20_public_info
                             + q34_02_face_mask
                             + q34_07_hand_washing 
                             + q35_01_contact_close_family
                             + q35_03_contact_friends
                             + q38_alcohol
                             + q40_smoking
                             + q42_sport
                             + q47_self_reporting_health
                             + q48_chronic_illness
                             + q49_health_limitations
                             , data = data)
                             , family = "yjPower")
(lambdaYJ <- YJ$lambda)

# Yeo-Johnson transformation of the dependent variable, adding it to the dataset
data["PHQ8_t"] <- car::yjPower(U = data$PHQ8, lambda = lambdaYJ)
```

## Overview of correlations between individual predictors and outcome

```{r correlation matrix, fig.height=9, fig.width=9}
# While the dataset has been already imported, the values of factor variables 
# were changed from numerics to text strings, therefore that dataset is unsuitable
# for correlation analysis. To solve this, we create a parallel dataset, 
# again renaming the key variables to a more understandable form.

data_corr <- data_corr %>% 
             transmute(country = Country,
                        q01_gender = Q3, 
                        q02_age = Q4,
                        q03_relationship_type = Q5,
                        q04_children = Q6,
                        # q11_education = Q13R,
                        q18_02_soc_media = replace_na(Q21_2, 0),
                        q20_public_info = Q23,
                        q34_02_face_mask = Q37_2,
                        q34_07_hand_washing = Q37_7,
                        q36_econ_worry = Q39,
                        q35_01_contact_close_family = Q38_1,
                        q35_03_contact_friends = Q38_3,
                        q38_alcohol = Q42,
                        q40_smoking = Q44,
                        q42_sport = Q46,
                        q47_self_reporting_health = Q50,
                        q48_chronic_illness = Q51,
                        q49_health_limitations = Q52) %>% 
              filter(country != 5) %>% 
              select(-country)

data_corr <- data_corr %>% mutate(info_missing = if_else(q20_public_info %in% c(NA, 1, 2), 0, 1))

data_corr["PHQ8_t"] <- car::yjPower(U = data$PHQ8, lambda = lambdaYJ)

res1 <- cor.mtest(data_corr, conf.level = .95)

# Filter column by name
data_corr[, !grepl("q20_public_info", colnames(data_corr))]

#Correlation matrix using Spearman coefficient (values with p > 0.05 are crossed)
corrplot(cor(data_corr, 
             method = "spearman", 
             use = "complete.obs"), 
             method = "circle", 
             title = "Correlation Matrix - Spearman Coefficient", 
             type = "lower", 
             p.mat = res1$p, 
             sig.level = .05, 
             mar = c(0,0,1,0))
```

```{r theory-driven regression model, comment = ""}

linreg_theory <- jmv::linReg(
    data = data,
    dep = "PHQ8_t",
    covs = "q02_age",
    factors = vars("q01_gender",
                   "q03_relationship_type",
                   "q04_children",
                   # "q11_education",
                   "q18_02_soc_media",
                   # "q20_public_info",
                   "q34_02_face_mask",
                   "q34_07_hand_washing",
                   "q35_01_contact_close_family",
                   "q35_03_contact_friends",
                   "q36_econ_worry",
                   "q38_alcohol",
                   "q40_smoking",
                   "q42_sport",
                   "q47_self_reporting_health",
                   "q48_chronic_illness",
                   "q49_health_limitations"),
    blocks = list(
        list(
            "q01_gender",
            "q02_age",
            "q03_relationship_type",
            "q04_children"),
            # "q11_education"),
        list(
            "q18_02_soc_media",
            # "q20_public_info",
            "q34_02_face_mask",
            "q34_07_hand_washing",
            "q36_econ_worry"),
        list(
            "q40_smoking",
            "q42_sport",
            "q38_alcohol",
            "q35_01_contact_close_family",
            "q35_03_contact_friends"),
        list(
            "q47_self_reporting_health",
            "q48_chronic_illness",
            "q49_health_limitations")),
    refLevels = list(
        list(
            var = "q01_gender",
            ref = "female"),
        list(
            var = "q04_children",
            ref = "no"),
         # list(
         #    var = "q20_public_info",
         #    ref = "no"),
        list(
            var = "q34_02_face_mask",
            ref = "no"),
        list(
            var = "q34_07_hand_washing",
            ref = "no"),
        list(
            var = "q36_econ_worry",
            ref = "very_serious"),
        list(
            var = "q42_sport",
            ref = "no"),
        list(
            var = "q40_smoking",
            ref = "yes"),
        list(
            var = "q38_alcohol",
            ref = "yes"),
        list(
            var = "q35_01_contact_close_family",
            ref = "less_often"),
        list(
            var = "q35_03_contact_friends",
            ref = "less_often"),
        list(
            var = "q18_02_soc_media",
            ref = "yes"),
        list(
            var = "q03_relationship_type",
            ref = "single"),
        list(
            var = "q47_self_reporting_health",
            ref = "very_bad"),
        list(
            var = "q49_health_limitations",
            ref = "limits"),
        # list(
        #     var = "q11_education",
        #     ref = "low"),
        list(
            var = "q48_chronic_illness",
            ref = "yes")),
    r2Adj = TRUE,
    aic = TRUE,
    bic = TRUE,
    rmse = TRUE,
    modelTest = TRUE,
    anova = TRUE,
    ci = TRUE,
    stdEst = TRUE,
    ciStdEst = TRUE,
    durbin = TRUE,
    collin = TRUE)

```

### Regression model performance {.tabset .tabset-pills}

#### Model fit measures

```{r, comment = ""}
linreg_theory$modelFit
```

#### Model comparisons

```{r, comment = ""}
linreg_theory$modelComp					
```

#### Model specific results

```{r, comment = ""}
linreg_theory$models				
```

```{r automatic stepwise regression model, comment = ""}

linreg_stepwise2 <- jmv::linReg(
    data = data,
    dep = "PHQ8_t",
    covs = "q02_age",
    factors = vars("q01_gender",
                   "q03_relationship_type",
                   "q04_children", 
                   "q18_02_soc_media", 
                   "q20_public_info",
                   "q34_02_face_mask",
                   "q36_econ_worry",
                   "q38_alcohol", 
                   "q40_smoking", 
                   "q47_self_reporting_health", 
                   "q48_chronic_illness",
                   "q49_health_limitations"),
    blocks = list(
        list(
            "q01_gender",
            "q02_age",
            "q04_children",
            "q36_econ_worry",
            "q18_02_soc_media",
            "q47_self_reporting_health",
            "q49_health_limitations"),
          list(
            "q03_relationship_type",
            "q20_public_info",
            "q34_02_face_mask",
            "q38_alcohol",
            "q40_smoking",
            "q48_chronic_illness")),
    refLevels = list(
        list(
            var = "q01_gender",
            ref = "female"),
        list(
            var = "q04_children",
            ref = "no"),
         list(
            var = "q20_public_info",
            ref = "no"),
        list(
            var = "q34_02_face_mask",
            ref = "no"),
        list(
            var = "q36_econ_worry",
            ref = "very_serious"),
        list(
            var = "q40_smoking",
            ref = "yes"),
        list(
            var = "q38_alcohol",
            ref = "yes"),
        list(
            var = "q18_02_soc_media",
            ref = "yes"),
        list(
            var = "q03_relationship_type",
            ref = "single"),
        list(
            var = "q47_self_reporting_health",
            ref = "very_bad"),
        list(
            var = "q49_health_limitations",
            ref = "limits"),
        list(
            var = "q48_chronic_illness",
            ref = "yes")),
    r2Adj = TRUE,
    aic = TRUE,
    bic = TRUE,
    rmse = TRUE,
    modelTest = TRUE,
    anova = TRUE,
    ci = TRUE,
    stdEst = TRUE,
    ciStdEst = TRUE,
    durbin = TRUE,
    collin = TRUE)

```

### Stepwise model performance {.tabset .tabset-pills}

#### Stepwise model fit measures

```{r, comment = ""}
linreg_stepwise2$modelFit
```

#### Stepwise model comparisons

```{r, comment = ""}
linreg_stepwise2$modelComp					
```

#### Stepwise model specific results

```{r, comment = ""}
linreg_stepwise2$models				
```

## Creation of the Covid-19 concern index, step 3: Reliability Analysis of the index items

Secondly, we conduct a Reliability Analysis of the Covid-19 concern factor. We use a cutoff value of 0.7 for both McDonald's Omega and Cronbach's Alpha. The scale passes this cutoff and the statistics would not be improved if any of the items were dropped.

```{r concern index reliability analysis, comment = ""}
# To conduct the reliability analysis, we use the reliability() function from the 
#  jmv package on the "test" data set (as opposed to the "train" dataset used for EFA).

jmv::reliability(
    data = data,
    vars = vars("q30_concern_infection_covid", 
                "q31_concern_infection_friends", 
                "q33_01_concern_situation", 
                "q33_02_concern_low_control", 
                "q33_03_concern_survival_covid", 
                "q33_05_concern_infecting_others"),
    omegaScale = TRUE,
    alphaItems = TRUE,
    omegaItems = TRUE)
```


## Creation of the Covid-19 concern index, step 4: Confirmatory Factor Analysis of the index items

```{r concern index Confirmatory Factor Analysis, comment = ""}
# To conduct the CFA, we use the cfa() function from the jmv package on the "test" 
# data set (as opposed to the "train" dataset used for EFA).

jmv::cfa(
    data = data,
    factors = list(
        list(
            label = "Concern",
            vars = c("q30_concern_infection_covid",
                     "q31_concern_infection_friends",
                     "q33_01_concern_situation",
                     "q33_02_concern_low_control",
                     "q33_03_concern_survival_covid",
                     "q33_05_concern_infecting_others"))),
    resCov = list(),
    ci = TRUE,
    stdEst = TRUE,
    factCovEst = FALSE,
    fitMeasures = c("cfi", "tli", "rmsea", "srmr"),
    corRes = TRUE)
```

```{r concern index creation and descriptives, comment = ""}
# Creating the Covid-19-related concern/anxiety index, consisting of the average of 
# the values of the multiple variables selected through factor analysis to
# represent the underlying construct.

concern_index <- apply(cbind(data$q30_concern_infection_covid,
                             data$q31_concern_infection_friends,
                             data$q33_01_concern_situation,
                             data$q33_02_concern_low_control,
                             data$q33_03_concern_survival_covid,
                             data$q33_05_concern_infecting_others), 1, mean)

#Adding the vector as an column to the existing dataset.

data <- cbind(data, concern_index)
data_corr <- cbind(data_corr, concern_index)


#To summarize the concern_index variable, we use the descriptives() 
# function from the jmv package.

anx_index_descriptives <- jmv::descriptives(data = data,
                                            missing = TRUE,
                                            vars = "concern_index",
                                            sd = TRUE,
                                            median = FALSE,
                                            pc = TRUE,
                                            range = TRUE,
                                            box = TRUE)

# Function to get the result from the correlation matrix into a data frame
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor = (cormat)[ut],
    p = pmat[ut]
    )
}

#Correlation matrix using Spearman coefficient 
corr_mtx <- rcorr(as.matrix(data_corr), type = "spearman")
 
# Selecting only significant correlates for PHQ8 (values with p>0.05 are excluded)
flattenCorrMatrix(corr_mtx$r, corr_mtx$P) %>% filter(p <= 0.05,
                                                     column %in% c("PHQ8_t")) %>% 
                                              arrange(desc(abs(cor)))

# Selecting only significant correlates for concern index (values with p>0.05 are excluded)
flattenCorrMatrix(corr_mtx$r, corr_mtx$P) %>% filter(p <= 0.05,
                                                     column %in% c("concern_index")) %>% 
                                              arrange(desc(abs(cor)))
```

### Covid-19 concern index results {.tabset .tabset-pills}

#### Plots

```{r anx index plot, comment = ""}

data %>%
  filter(concern_index != "NA") %>% 
  ggplot(aes(y = concern_index)) +
         geom_boxplot(fill = "#4DBBD5CC") +
         theme_bw() +
         scale_y_continuous(breaks = seq(0, 10, 1), 
                            labels = seq(0, 10, 1), 
                            limits = c(0, 10)) +
         theme(legend.position = "none", 
               axis.title.x = element_blank(),
               axis.text.x = element_blank(), 
               axis.ticks.x = element_blank(), 
               axis.line.x = element_blank(), 
               panel.grid.major.x = element_blank(), 
               panel.grid.minor = element_blank()) + 
         ylab("Concern Index")

data %>% 
   filter(concern_index != "NA") %>% 
   ggplot(aes(x = concern_index)) +
        geom_density(fill = "#4DBBD5CC") +
        scale_x_continuous(breaks = seq(0, 10, 1), 
                           labels = seq(0, 10, 1), 
                           limits = c(0, 10)) +
         theme_bw() +
         theme(legend.position = "none") + 
         xlab("Concern Index")
```

#### Descriptives

```{r anx index results, comment = ""}
anx_index_descriptives$descriptives	
```

# Path analysis with a simplified model

## Moderated mediation model diagrams and pre-processing

```{r Hayes model 76 pre-processing}
# Before running the model, we need to transform the social media string 
# dummy (yes/no) back to its numeric form, with similar operation for gender.

levels(data$q18_02_soc_media) <- list("1" = "yes", "0" = "no")
levels(data$q01_gender) <- list("0" = "male", "1" = "female", "2" = "other")
data$q01_gender <- as.numeric(as.character(data$q01_gender))
data$q18_02_soc_media <- as.numeric(as.character(data$q18_02_soc_media))

# Centering continuous variables with scaling
data_sem <- data %>% 
            filter(q01_gender != 2, !is.na(concern_index)) %>% 
            mutate(concern_index.c = scale(concern_index, scale = TRUE),
                   PHQ8.c = scale(PHQ8_t, scale = TRUE),
                   q02_age.c = scale(q02_age, scale = TRUE))

# Labels for diagrams
labels_H76 <- list(X = "Social Media", 
                   M = "Concern", 
                   Y = "Depression", 
                   W = "Age", 
                   Z = "Gender")
```

### Path analysis model structure {.tabset .tabset-pills}

#### Conceptual diagram

```{r fig.height=7, fig.width=9}
pmacroModel(no = 76,
            labels = labels_H76,
            xmargin = 0,
            rady = 0.047,
            radx = 0.09,
            ylim = c(0.15, 0.8))
```

#### Statistical diagram with path names

```{r fig.height=7, fig.width=9}
statisticalDiagram(no = 76,
                   labels = labels_H76,
                   whatLabel = "name",
                   xmargin = 0.01,
                   rady = 0.03,
                   radx = 0.11,
                   ylim = c(0.06, 0.95),
                   xlim = c(0.01, 1))
```

## Moderated mediation model specification and results

In the second step, we specify the key pathways and run the analysis, while bootstrapping the confidence intervals.

```{r Hayes model 76, warning=FALSE, comment = ""}
# Mediation-moderation analysis (path analysis framework, SEM) using lavaan package.

# First, we specify the model pathways
spec_mod <- "
# Regressions
concern_index.c ~ a1*q18_02_soc_media + a2*q02_age.c + a3*q01_gender + a4*q18_02_soc_media:q02_age.c + a5*q18_02_soc_media:q01_gender

PHQ8.c ~ c1*q18_02_soc_media + c2*q02_age.c + c3*q01_gender + c4*q18_02_soc_media:q02_age.c + c5*q18_02_soc_media:q01_gender + b1*concern_index.c + b2*concern_index.c:q02_age.c + b3*concern_index.c:q01_gender

#Mean and variance of age and gender moderators
q02_age.c ~ q02_age.c.mean*1
q02_age.c ~~ q02_age.c.var*q02_age.c
q01_gender ~ q01_gender.mean*1
q01_gender ~~ q01_gender.var*q01_gender

# Effect specifications
XonM := a1 + a4*q02_age.c.mean + a5*q01_gender.mean
MonY := b1 + b2*q02_age.c.mean + b3*q01_gender.mean
indirect := (a1 + a4*q02_age.c.mean + a5*q01_gender.mean)*(b1 + b2*q02_age.c.mean + b3*q01_gender.mean)
direct := c1 + c4*q02_age.c.mean + c5*q01_gender.mean
total := direct + indirect
prop.mediated := indirect / total

# Component effects conditional on moderators (X = Social Media, M = Concern, Y = Depression, W = Age, Z = Gender)
XonM.mean.male := a1 + a4*q02_age.c.mean + a5*0
XonM.mean.female := a1 + a4*q02_age.c.mean + a5*1

XonM.blw.male := a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*0
XonM.blw.female := a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*1
XonM.blw.avg := a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*q01_gender.mean

XonM.abv.male := a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*0
XonM.abv.female := a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*1
XonM.abv.avg := a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*q01_gender.mean

MonY.mean.male := b1 + b2*q02_age.c.mean + b3*0
MonY.mean.female := b1 + b2*q02_age.c.mean + b3*1

MonY.blw.male := b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*0
MonY.blw.female := b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*1
MonY.blw.avg := b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*q01_gender.mean

MonY.abv.male := b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*0
MonY.abv.female := b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*1
MonY.abv.avg := b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*q01_gender.mean

# Indirect effects conditional on moderators
indirect.mean.male := (a1 + a4*q02_age.c.mean + a5*0)*(b1 + b2*q02_age.c.mean + b3*0)
indirect.mean.female := (a1 + a4*q02_age.c.mean + a5*1)*(b1 + b2*q02_age.c.mean + b3*1)

indirect.blw.male := (a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*0)*(b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*0)
indirect.blw.female := (a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*1)*(b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*1)
indirect.blw.avg := (a1 + a4*(q02_age.c.mean - sqrt(q02_age.c.var)) + a5*q01_gender.mean)*(b1 + b2*(q02_age.c.mean - sqrt(q02_age.c.var)) + b3*q01_gender.mean)

indirect.abv.male := (a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*0)*(b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*0)
indirect.abv.female := (a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*1)*(b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*1)
indirect.abv.avg := (a1 + a4*(q02_age.c.mean + sqrt(q02_age.c.var)) + a5*q01_gender.mean)*(b1 + b2*(q02_age.c.mean + sqrt(q02_age.c.var)) + b3*q01_gender.mean)

# Direct effects conditional on moderators
direct.mean.male := c1 + c4*q02_age.c.mean + c5*0
direct.mean.female := c1 + c4*q02_age.c.mean + c5*1

direct.blw.male := c1 + c4*(q02_age.c.mean - sqrt(q02_age.c.var)) + c5*0
direct.blw.female := c1 + c4*(q02_age.c.mean - sqrt(q02_age.c.var)) + c5*1
direct.blw.avg := c1 + c4*(q02_age.c.mean - sqrt(q02_age.c.var)) + c5*q01_gender.mean

direct.abv.male := c1 + c4*(q02_age.c.mean + sqrt(q02_age.c.var)) + c5*0
direct.abv.female := c1 + c4*(q02_age.c.mean + sqrt(q02_age.c.var)) + c5*1
direct.abv.avg := c1 + c4*(q02_age.c.mean + sqrt(q02_age.c.var)) + c5*q01_gender.mean

# Total effects conditional on moderators
total.mean.male := direct.mean.male + indirect.mean.male
total.mean.female := direct.mean.female + indirect.mean.female

total.blw.male := direct.blw.male + indirect.blw.male
total.blw.female := direct.blw.female + indirect.blw.female
total.blw.avg := direct.blw.avg + indirect.blw.avg

total.abv.male := direct.abv.male + indirect.abv.male
total.abv.female := direct.abv.female + indirect.abv.female
total.abv.avg := direct.abv.avg + indirect.abv.avg

# Proportion mediated conditional on moderators
prop.med.mean.male := indirect.mean.male / total.mean.male
prop.med.mean.female := indirect.mean.female / total.mean.female

prop.med.blw.male := indirect.blw.male / total.blw.male
prop.med.blw.female := indirect.blw.female / total.blw.female
prop.med.blw.avg := indirect.blw.avg / total.blw.avg

prop.med.abv.male := indirect.abv.male / total.abv.male
prop.med.abv.female := indirect.abv.female / total.abv.male
prop.med.abv.avg := indirect.abv.avg / total.abv.avg"

# For reproducibility of results (using bootstrap)
set.seed(2021)

# Secondly, we fit/estimate the model and we use bootstrap for robustness.
fit_mod <- lavaan::sem(model = spec_mod,
               data = data_sem,
               se = "bootstrap",
               bootstrap = 1000)

# Labels for statistical diagrams
labels_stats_H76 <- list(X = "q18_02_soc_media",
                         M = "concern_index.c",
                         Y = "PHQ8.c",
                         W = "q02_age.c",
                         Z = "q01_gender")
```

### Path analysis model summary, estimates and statistical diagram {.tabset .tabset-pills}

#### Diagram with unstandardized coefficients

```{r fig.height=7, fig.width=9}
statisticalDiagram(no = 76,
                   labels = labels_stats_H76,
                   fit = fit_mod,
                   whatLabel = "est",
                   xmargin = 0.01,
                   rady = 0.03,
                   radx = 0.158,
                   ylim = c(0.06, 0.95),
                   xlim = c(0.01, 1))
```

#### Diagram with standardized coefficients

```{r fig.height=7, fig.width=9}
statisticalDiagram(no = 76,
                   labels = labels_stats_H76,
                   fit = fit_mod,
                   whatLabel = "std",
                   xmargin = 0.01,
                   rady = 0.03,
                   radx = 0.158,
                   ylim = c(0.06, 0.95),
                   xlim = c(0.01, 1))
```

#### Detailed model summary

```{r,  comment = ""}
lavaan::summary(fit_mod, 
                rsquare = TRUE, 
                ci = TRUE,
                fit.measures = TRUE,
                standardize = TRUE)
```

#### Table of model estimates

```{r}
estimates <- parameterEstimates(fit_mod, standardized = TRUE) %>% 
                    filter(op == "~") %>% 
                    select(-c(std.nox))

p_adj <- p.adjust(estimates$pvalue, method = "holm")

estimates <- cbind(estimates, p_adj)

kbl(estimates) %>%
kable_classic(full_width = FALSE, lightable_options = c("striped")) %>%
                    row_spec(row = which(estimates$p_adj < 0.05), bold = TRUE)
```

#### Table of defined parameters

```{r}
parameters <- parameterEstimates(fit_mod, standardized = TRUE) %>% 
                    filter(op == ":=") %>% 
                    select(-c(op, lhs, rhs, std.nox))

p_adj <- p.adjust(parameters$pvalue, method = "holm")

parameters <- cbind(parameters, p_adj)

kbl(parameters) %>%
kable_classic(full_width = FALSE, lightable_options = c("striped")) %>%
                    row_spec(row = which(parameters$p_adj < 0.05), bold = TRUE)
```


# Clustering (K-Medoids)

We are conducting clustering with the K-Medoids algorithm to find distinct groups in our dataset. We are only using a subset of the dataset, which contains values that we used in the previous step within the path model - age, gender, social media, concern index and PHQ8. The reasoning is to supplement the insights from the path model, while also limiting ourselves only to the core variables, most of them showing relatively strong effects in the regression models.

```{r eval=FALSE, include=FALSE}

library(fpc)
library(NbClust)

data_scaled <- data %>%
 select(q01_gender, q02_age, q18_02_soc_media, PHQ8, concern_index) %>%
 na.omit() %>%
 scale()
data_scaled <- na.omit(scale(data_corr))

# Calculate the matrix of distance, we can choose from many methods

m.distance <- get_dist(data_scaled, method = "kendall")
fviz_dist(m.distance, gradient = list(low = "blue", mid = "white", high = "red"))
fviz_nbclust(data_scaled, pam, method = "wss")
fviz_nbclust(data_scaled, pam, method = "silhouette")
fviz_nbclust(data_scaled, pam, method = "gap_stat")
resnumclust <- NbClust(data_scaled, distance = "euclidean", min.nc = 2, max.nc = 10, method = "median", index = "alllong")

resnumclust

fviz_nbclust(resnumclust)

# 3 seems to be the suggested number of clusters

```


```{r message=FALSE, warning=FALSE}

data_scaled <- data %>% 
  select(q01_gender, q02_age, q18_02_soc_media, PHQ8, concern_index) %>% 
  na.omit() %>% 
  scale()


set.seed(2021)

pam3 <- pam(data_scaled, 3)

# res3 <- hcut(data_scaled, k = 3, stand = TRUE, method = "median")
# fviz_dend(res3, rect = TRUE, cex = 0.5,
#           k_colors = "simpsons")



# cluster_sum <- as_tibble(data_scaled) %>%
#   mutate(cluster = as_factor(pam3$clustering)) %>%
#   group_by(cluster) %>%
#   summarise_all("mean")

```

### Clustering visualisations {.tabset .tabset-pills}

#### Visualisation of the clusters

```{r}
fviz_cluster(pam3, data = data_scaled, ellipse.type = "norm", palette = c("#E64B3599", "#4DBBD599", "#00A08799"), ggtheme = theme_bw(), main = "Cluster plot - K-Medoids algorithm")
```

#### Mean values of the distinct groups

```{r message=FALSE, warning=FALSE}
data_scaled_df <- as_tibble(data_scaled)
data_scaled_df$cluster <- as_factor(pam3$clustering)
data_scaled_df_long <- data_scaled_df %>% pivot_longer(cols = q01_gender:concern_index, names_to = "variable", values_to = "value")

ggplot(data_scaled_df_long, aes(x = variable, y = value, group = cluster, colour = cluster)) + 
       stat_summary(fun = mean, geom = "pointrange", size = 1, aes(shape = cluster)) +
       stat_summary(geom = "line") +
       scale_color_manual(values = c("#E64B35CC", "#4DBBD5CC", "#00A087CC")) + 
       ggtitle("Average value of selected variables per cluster") + 
       theme_bw() +
       ylab("relative value")

```

